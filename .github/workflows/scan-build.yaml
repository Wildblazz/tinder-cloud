name: Scan and Build Services

on:
  pull_request:
    paths:
      - 'be-components/**'

jobs:
  detect-changed-services:
    runs-on: [ self-hosted, arm64 ]
    outputs:
      changed_services: ${{ steps.process-services.outputs.services }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get changed services
        id: changed-services
        uses: tj-actions/changed-files@v45
        with:
          files: be-components/**
          dir_names: true
          dir_names_max_depth: 2

      - name: Process changed services
        id: process-services
        run: |
          changed_dirs="${{ steps.changed-services.outputs.all_changed_files }}"
          services=""

          for dir in $changed_dirs; do
            service_name=$(basename "$dir")
            if [ "$service_name" != "be-components" ] && [ "$service_name" != "gradle" ] && [ -d "be-components/$service_name" ] && [ -f "be-components/$service_name/build.gradle.kts" ]; then
              services="$services $service_name"
            fi
          done

          services=$(echo "$services" | tr ' ' '\n' | sort -u | tr '\n' ' ' | xargs)
          echo "services=$services" >> $GITHUB_OUTPUT
          echo "Changed services: $services"

  build-services:
    runs-on: [self-hosted, arm64]
    needs: detect-changed-services
    if: needs.detect-changed-services.outputs.changed_services != ''
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21

      - name: Make gradlew executable
        run: chmod +x be-components/gradlew

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-arm64-${{ runner.os }}-${{ hashFiles('**/build.gradle.kts', '**/gradle-wrapper.properties') }}

      - name: Build changed services
        working-directory: be-components
        run: |
          services="${{ needs.detect-changed-services.outputs.changed_services }}"
          build_tasks=""
          
          for service in $services; do
            build_tasks="$build_tasks :$service:build"
          done
          
          ./gradlew $build_tasks -x test --parallel --build-cache

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            be-components/*/build/libs/**/*.jar
            be-components/*/build/classes/**
            be-components/*/build/resources/**
          retention-days: 1

  scan-services:
    runs-on: [self-hosted, x64]
    needs: [detect-changed-services, build-services]
    if: needs.detect-changed-services.outputs.changed_services != ''
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: be-components/

      - name: Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@v0.16.0
        with:
          scan-type: fs
          scan-ref: be-components/
          format: table
          exit-code: 1
          severity: HIGH,CRITICAL
          ignore-unfixed: true

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java-kotlin
          queries: security-extended,security-and-quality

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  test-and-build:
    runs-on: [self-hosted, arm64]
    needs: [detect-changed-services, build-services]
    if: needs.detect-changed-services.outputs.changed_services != ''
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21

      - name: Make gradlew executable
        run: chmod +x be-components/gradlew

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-arm64-${{ runner.os }}-${{ hashFiles('**/build.gradle.kts', '**/gradle-wrapper.properties') }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: be-components/

      - name: Run tests and create artifacts
        working-directory: be-components
        run: |
          services="${{ needs.detect-changed-services.outputs.changed_services }}"
          
          for service in $services; do
            echo "Testing and building service: $service"
            ./gradlew :$service:test :$service:build --parallel --build-cache
          done

      - name: Upload final artifacts
        uses: actions/upload-artifact@v4
        with:
          name: final-artifacts
          path: |
            be-components/*/build/libs/**/*.jar
            be-components/*/build/reports/**
          retention-days: 7

  cleanup:
    runs-on: [self-hosted, arm64]
    needs: [scan-services, test-and-build]
    if: always()
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Make gradlew executable
        run: chmod +x be-components/gradlew

      - name: Cleanup Gradle
        working-directory: be-components
        run: |
          ./gradlew clean --stop || true
        continue-on-error: true
